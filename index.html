<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم کاوش طرح‌های برش</title>
    <!-- افزودن کتابخانه SheetJS برای کار با فایل‌های اکسل -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-FD-NL.woff2') format('woff2');
            font-weight: 100 900;
            font-style: normal;
            font-display: swap;
        }
        * { 
            box-sizing: border-box; 
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        .logo-image {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 100px;
            height: auto;
            z-index: 1;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .logo-image:hover {
            transform: scale(1.1);
        }
        .aabsal-logo-image {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 100px;
            height: auto;
            z-index: 1;
            transition: transform 0.2s;
        }
        .aabsal-logo-image:hover {
            transform: scale(1.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: 800;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
        }
        .page { 
            display: none; 
        }
        .page.active { 
            display: block; 
        }
        .form-section, .list-section, .results-section, .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            position: relative;
            z-index: 1;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
            gap: 15px;
            border-bottom: 2px solid #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        .section-header h2, .settings-section h3 {
            border-bottom: none;
            margin-bottom: 0;
            margin-left: auto; /* هدر را به سمت راست هل می‌دهد */
        }
        .section-header .io-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .io-buttons .btn {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 15px;
        }
        /* استایل اختصاصی برای دکمه‌های اصلی که به هدر منتقل شده‌اند */
        .io-buttons .btn-main-action {
            font-size: 16px;
            padding: 10px 20px;
            border-radius: 25px;
        }
        h2 {
            color: #495057;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6em;
            font-weight: 700;
        }
        h3 {
             color: #343a40;
             margin-top: 25px;
             margin-bottom: 15px;
             font-size: 1.3em;
             font-weight: 700;
             border-bottom: 2px solid #e9ecef;
             padding-bottom: 10px;
        }
        .input-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px; 
        }
        .settings-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; 
        }
        .input-item { 
            display: flex;
            flex-direction: column; 
        }
        .input-item label { 
            margin-bottom: 8px;
            font-weight: 700;
            color: #495057; 
        }
        .input-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
            align-self: flex-start;
            margin-top: 5px;
        }
        input, select {
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            font-size: 16px;
            font-family: 'Vazirmatn', sans-serif;
            transition: border-color 0.3s;
            background-color: white;
        }
        input[readonly] { 
            background-color: #e9ecef;
            cursor: not-allowed; 
        }
        input:focus, select:focus { 
            outline: none;
            border-color: #667eea; 
        }
        .btn {
            font-family: 'Vazirmatn', sans-serif;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            text-align: center;
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15); 
        }
        .btn-primary { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
        }
        .btn-success { 
            background: linear-gradient(45deg, #28a745, #20c997); 
        }
        .btn-secondary { 
            background: #6c757d; 
        }
        .btn-warning { 
            background: #ffc107; color: #212529;
        }
        .btn-danger { 
            background: #dc3545; 
        }
        .form-buttons-container { 
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px; 
        }
        .form-buttons-container .btn { 
            width: auto;
            max-width: 220px;
            margin: 0;
            flex-grow: 1; 
        }
        .nav-buttons { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 15px; 
        }
        .table-container { 
            margin-top: 20px;
            overflow-x: auto; 
        }
        table { 
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08); 
        }
        th, td { 
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e9ecef; 
        }
        th { 
            background: #667eea;
            color: white;
            font-weight: 700; 
        }
        tr:hover td { 
            background-color: #f1f3f5; 
        }
        .operations-cell, .settings-item { 
            display: flex;
            gap: 8px;
            align-items: center; 
        }
        .operations-cell .btn, .settings-item .btn { 
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
            margin: 0; 
        }
        .modal { 
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center; 
        }
        .modal-content { 
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative; 
        }
        .modal-content h2 { 
            text-align: center;
            margin-top: 0; 
        }
        #errorModal .modal-content p { 
            color: #721c24;
            margin: 0 0 20px;
            font-size: 1.1em;
            text-align: center; 
        }
        #aboutModal .modal-content p { 
            color: #333;
            margin: 10px 0;
            font-size: 1.1em;
            text-align: right; 
        }
        #aboutModal .modal-content p strong { 
            color: #667eea; 
        }
        .close-btn { 
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 1.4em;
            cursor: pointer;
            color: #aaa; 
        }
        .app-footer { 
            text-align: left;
            margin-top: 30px;
            border-top: 1px solid #e9ecef;
            padding-top: 15px; 
        }
        .app-footer .btn { 
            font-size: 14px;
            padding: 8px 15px; 
        }
        .settings-item { 
            justify-content: space-between;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 8px; 
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <!-- لوگوها -->
        <img src="images/Saeed4.png" alt="درباره برنامه" title="درباره برنامه" class="logo-image" onclick="showAboutModal()">
        <img src="images/Aabsal Logo.png" alt="لوگوی آبسال" title="لوگوی آبسال" class="aabsal-logo-image" id="aabsalLogo">
        
        <h1>سیستم کاوش طرح‌های برش</h1>
        
        <div id="errorModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeModal()">×</span><p id="errorMessage"></p><button class="btn btn-primary" onclick="closeModal()">بستن</button></div></div>
        <div id="aboutModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeAboutModal()">×</span><h2>درباره برنامه</h2><p><strong>نویسنده برنامه:</strong> سعید گلستانی</p><p><strong>تاریخ ارائه:</strong> ۲۱ تیر ماه ۱۴۰۴</p><p><strong>تلفن تماس:</strong> 09123175863</p><div style="text-align: center; margin-top: 25px;"><button class="btn btn-primary" onclick="closeAboutModal()">بستن</button></div></div></div>
     
		<div id="helpModal" class="modal">
		<div class="modal-content" style="max-width: 700px; text-align: right;">
			<span class="close-btn" onclick="closeHelpModal()">×</span>
			<h2>راهنمای استفاده از برنامه</h2>
			<h4>مقدمه</h4>
			<p>این برنامه به شما کمک می‌کند تا بهترین طرح‌های ممکن برای برش ورق از کویل‌های موجود را پیدا کرده و ضایعات (پرتی) را به حداقل برسانید.</p>
			<hr>
			<h4>مرحله ۱: ورود کویل‌ها</h4>
			<ul>
				<li><strong>نوع ورق، ویژگی، عرض و ضخامت:</strong> مشخصات فیزیکی کویل خود را وارد کنید. این مشخصات برای تطبیق با سفارش‌ها استفاده می‌شوند.</li>
				<li><strong>وزن و دانسیته:</strong> این دو مقدار برای محاسبه طول کل کویل به کار می‌روند. طول بیشتر به معنای تعداد برش بیشتر است.</li>
			</ul>
			<h4>مرحله ۲: ورود ابعاد برش</h4>
			<ul>
				<li>در این بخش، ابعاد ورق‌هایی که می‌خواهید برش دهید را وارد کنید.</li>
				<li>توجه کنید که لیست‌های کشویی **"ضخامت"** و **"ویژگی"** فقط مقادیری را نمایش می‌دهند که برای آن‌ها کویل موجود در انبار (مرحله ۱) ثبت شده باشد.</li>
			</ul>
			<h4>نمایش نتایج</h4>
			<p>پس از کلیک روی دکمه "نمایش طرح‌های ممکن"، برنامه تمام ترکیب‌های ممکن را بر اساس شرایط زیر نمایش می‌دهد:</p>
			<ul>
				<li>تطابق کامل **نوع ورق، ویژگی و ضخامت** بین کویل و سفارش.</li>
				<li>مجموع عرض ورق‌های سفارش نباید از عرض کویل بیشتر باشد.</li>
				<li>درصد ضایعات طرح باید کمتر از مقدار تعیین شده توسط شما باشد.</li>
			</ul>
			<hr>
			<h4>ورود و خروج با Excel</h4>
			<p>برای ورود اطلاعات از فایل اکسل، فایل شما باید دقیقاً شامل ستون‌های زیر (با همین نام) باشد:</p>
			<p><strong>برای کویل‌ها:</strong> <code>کد انبار</code>, <code>نوع</code>, <code>ویژگی</code>, <code>وزن</code>, <code>عرض</code>, <code>ضخامت</code>, <code>دانسیته</code></p>
			<p><strong>برای ابعاد برش:</strong> <code>کد انبار</code>, <code>نوع</code>, <code>ویژگی</code>, <code>طول</code>, <code>عرض</code>, <code>ضخامت</code></p>
			<div style="text-align: center; margin-top: 25px;">
				<button class="btn btn-primary" onclick="closeHelpModal()">متوجه شدم</button>
			</div>
        </div>
		</div>

        <div id="page-coils" class="page active"></div>
        <div id="page-sheets" class="page"></div>
        <div id="page-results" class="page"></div>
        <div id="page-settings" class="page"></div>

        <div class="app-footer">
 			<button class="btn btn-warning" onclick="showHelpModal()">راهنما</button>
			<button class="btn btn-secondary" onclick="showSettingsPage()">تنظیمات</button>
		</div>
    </div>

<script>
// --- GLOBAL VARIABLES & CONSTANTS ---
let coils = [];
let sheetOrders = [];
let editingCoilId = null;
let editingSheetId = null;

// Default settings
let settings = {
    username: 'admin',
    password: '123',
    superPassword: 'dev', 
    densities: {
        'روغنی': 7.85,
        'گالوانیزه': 7.84,
        'استیل': 7.83,
        'آلودیپ': 7.82 
    },
    features: ["معمولی", "کششی", "EK2", "EK4", "روکش دار"],
    expireDate: '2025-12-31',
    showAabsalLogo: true 
};

const COILS_STORAGE_KEY = 'cuttingOptimizerCoils_v21';
const ORDERS_STORAGE_KEY = 'cuttingOptimizerOrders_v21';
const SETTINGS_STORAGE_KEY = 'cuttingOptimizerSettings_v21';

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', initializeApp);

function initializeApp() {
    loadSettings();
    updateLogoVisibility(); 
    if (checkExpiration()) return;
    loadDataFromLocalStorage();
    buildPageHTML();
    populateFormDropdowns();
    showCoilPage();
    updateDensity();
    renderCoilList();
    renderSheetOrderList();
}

// --- SETTINGS & AUTHENTICATION LOGIC ---
function loadSettings() {
    const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
    if (savedSettings) {
        const loadedSettings = JSON.parse(savedSettings);
        settings = { ...settings, ...loadedSettings };
    }
}

// ******** FUNCTION REPLACED (START) ********
// This function has been rewritten to be safer.
function saveSettings() {
    // Create a temporary object to hold potential changes.
    const potentialSettings = JSON.parse(JSON.stringify(settings));

    // Handle advanced settings only if they are visible.
    // Types and Features are managed directly and don't need to be in this transaction.
    if (document.getElementById('advanced-settings-fields').style.display === 'block') {
        potentialSettings.showAabsalLogo = document.getElementById('setting-show-aabsal-logo').checked;
        
        const newUsername = document.getElementById('setting-username').value.trim();
        if (newUsername) {
            potentialSettings.username = newUsername;
        }
        
        const newPassword = document.getElementById('setting-password').value.trim();
        if (newPassword) {
            if (confirm('آیا مطمئن هستید که می‌خواهید رمز عبور کاربر را تغییر دهید؟')) {
                potentialSettings.password = newPassword;
            } else {
                alert('تغییر رمز عبور کاربر لغو شد. هیچ تغییری ذخیره نشد.');
                document.getElementById('setting-password').value = ''; // Clear the input field
                return; // Abort the entire save operation
            }
        }

        const newSuperPassword = document.getElementById('setting-super-password').value.trim();
        if (newSuperPassword) {
            if (confirm('آیا مطمئن هستید که می‌خواهید رمز عبور پیشرفته را تغییر دهید؟')) {
                potentialSettings.superPassword = newSuperPassword;
            } else {
                alert('تغییر رمز عبور پیشرفته لغو شد. هیچ تغییری ذخیره نشد.');
                document.getElementById('setting-super-password').value = ''; // Clear the input field
                return; // Abort the entire save operation
            }
        }
        
        potentialSettings.expireDate = document.getElementById('setting-expire-date').value;
    }

    // If all confirmations passed, apply the changes to the main settings object.
    settings = potentialSettings;

    // Save all settings (including types/features which were modified directly on the original object)
    localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
    
    // Update UI elements based on new settings
    updateLogoVisibility(); 
    populateFormDropdowns();
    updateDensity();
    
    alert('تنظیمات با موفقیت ذخیره شد.');
}
// ******** FUNCTION REPLACED (END) ********


function checkExpiration() {
    const today = new Date();
    const expire = new Date(settings.expireDate);
    today.setHours(0, 0, 0, 0);
    if (today > expire) {
        document.getElementById('mainContainer').innerHTML = `<h1>اعتبار این نسخه از برنامه به پایان رسیده است.</h1>`;
        return true;
    }
    return false;
}

function handleLogin() {
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;

    if (user === settings.username && pass === settings.password) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('settings-section').style.display = 'block';
        populateSettingsForm();
    } else {
        alert('نام کاربری یا رمز عبور اشتباه است.');
    }
}

function showAdvancedSettings() {
    const pass = prompt("لطفاً رمز دسترسی پیشرفته را وارد کنید:");
    if (pass === settings.superPassword) {
        document.getElementById('advanced-settings-fields').style.display = 'block';
    } else if (pass !== null) { 
        alert('رمز عبور اشتباه است.');
    }
}

function populateSettingsForm() {
    document.getElementById('setting-show-aabsal-logo').checked = settings.showAabsalLogo;
    document.getElementById('setting-username').value = settings.username;
    document.getElementById('setting-password').value = '';
    document.getElementById('setting-super-password').value = '';
    document.getElementById('setting-expire-date').value = settings.expireDate;
    
    renderSettingTypes();
    renderSettingFeatures();
}

// --- HTML & PAGE BUILDING ---
function buildPageHTML() {
    // Page 1: Coils
    document.getElementById('page-coils').innerHTML = `
        <div class="form-section">
            <h2>مرحله ۱: افزودن و ویرایش کویل‌ها</h2>
            <div class="input-grid">
                <div class="input-item"><label for="coilType">نوع ورق:</label><select id="coilType" onchange="updateDensity()"></select></div>
                <div class="input-item"><label for="coilCompanyCode">کد انبار:</label><input type="text" id="coilCompanyCode" placeholder="مثال: C-123"></div>
                <div class="input-item"><label for="coilFeature">ویژگی ورق:</label><select id="coilFeature"></select></div>
                <div class="input-item"><label for="coilWeight">وزن (ک.گ):</label><input type="number" id="coilWeight" placeholder="مثال: 5000"></div>
                <div class="input-item"><label for="coilWidth">عرض (م.م):</label><input type="number" id="coilWidth" placeholder="مثال: 1250"></div>
                <div class="input-item"><label for="coilThickness">ضخامت (م.م):</label><input type="number" id="coilThickness" step="0.01" placeholder="مثال: 0.5"></div>
                <div class="input-item"><label for="coilDensity">دانسیته (g/cm³):</label><input type="number" id="coilDensity" step="0.01" readonly></div>
            </div>
            <div class="form-buttons-container">
                <button id="coilSubmitBtn" class="btn btn-primary" onclick="saveCoil()">افزودن کویل</button>
                <button id="coilCancelBtn" class="btn btn-secondary" onclick="cancelCoilEdit()" style="display: none;">لغو ویرایش</button>
            </div>
        </div>
        <div class="list-section">
            <div class="section-header">
                <h2>لیست کویل‌ها</h2>
                <div class="io-buttons">
                    <button class="btn btn-primary" onclick="importFromXLSX('coils')">ورود از Excel</button>
                    <button class="btn btn-success" onclick="exportToXLSX('coils')">خروجی به Excel</button>
                    <button class="btn btn-danger" onclick="clearAllCoils()">پاک کردن همه</button>
                    <button class="btn btn-success btn-main-action" onclick="showSheetPage()">مرحله بعد: افزودن ابعاد برش ←</button>
                </div>
            </div>
            <div class="table-container" id="coilList"></div>
        </div>`;

    // Page 2: Sheets
    document.getElementById('page-sheets').innerHTML = `
        <div class="form-section">
            <h2>مرحله ۲: افزودن و ویرایش ابعاد برش</h2>
            <div class="input-grid">
                <div class="input-item"><label for="sheetType">نوع ورق:</label><select id="sheetType" onchange="updateSheetDependencies()"></select></div>
                <div class="input-item"><label for="sheetCompanyCode">کد انبار:</label><input type="text" id="sheetCompanyCode" placeholder="مثال: S-456"></div>
                <div class="input-item"><label for="sheetThickness">ضخامت (م.م):</label><select id="sheetThickness" onchange="updateAvailableFeatures()"></select></div>
                <div class="input-item"><label for="sheetFeature">ویژگی ورق:</label><select id="sheetFeature"></select></div>
                <div class="input-item"><label for="sheetLength">طول ورق (م.م):</label><input type="number" id="sheetLength" placeholder="مثال: 2000"></div>
                <div class="input-item"><label for="sheetWidth">عرض ورق (م.م):</label><input type="number" id="sheetWidth" placeholder="مثال: 1000"></div>
            </div>
            <div class="form-buttons-container">
                <button id="sheetSubmitBtn" class="btn btn-primary" onclick="saveSheetOrder()">افزودن ابعاد</button>
                <button id="sheetCancelBtn" class="btn btn-secondary" onclick="cancelSheetEdit()" style="display: none;">لغو ویرایش</button>
            </div>
        </div>
        <div class="list-section">
            <div class="section-header">
                <h2>لیست ابعاد برش</h2>
                <div class="io-buttons">
                    <button class="btn btn-primary" onclick="importFromXLSX('sheets')">ورود از Excel</button>
                    <button class="btn btn-success" onclick="exportToXLSX('sheets')">خروجی به Excel</button>
                    <button class="btn btn-danger" onclick="clearAllSheetOrders()">پاک کردن همه</button>
                    <button class="btn btn-success btn-main-action" onclick="runOptimization()">نمایش طرح‌های ممکن</button>
                </div>
            </div>
            <div class="table-container" id="sheetOrderList"></div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="showCoilPage()">→ بازگشت به ورود کویل‌ها</button>
            <div class="input-item" style="flex-grow: 1; max-width: 250px;">
                <label for="maxWaste">حداکثر ضایعات مجاز (%):</label>
                <input type="number" id="maxWaste" min="0" max="100" value="10" placeholder="0-100">
            </div>
        </div>`;
    
    // Page 3: Results
    document.getElementById('page-results').innerHTML = `
        <div class="results-section">
            <h2>نتایج: تمام طرح‌های برش ممکن</h2>
            <div id="resultsContainer"></div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-danger" onclick="startOver()">شروع مجدد</button>
            <button class="btn btn-warning" onclick="showSheetPage()">ویرایش ورودی‌ها</button>
        </div>`;
    
    // Page 4: Settings
    document.getElementById('page-settings').innerHTML = `
        <div id="login-section">
            <h2>ورود به بخش تنظیمات</h2>
            <div class="settings-grid">
                <div class="input-item"><label for="username">نام کاربری:</label><input type="text" id="username"></div>
                <div class="input-item"><label for="password">رمز عبور:</label><input type="password" id="password"></div>
            </div>
            <div class="form-buttons-container"><button class="btn btn-primary" onclick="handleLogin()">ورود</button></div>
        </div>
        <div id="settings-section" class="settings-section" style="display: none;">
            <h2>تنظیمات برنامه</h2>
            
            <button class="btn btn-warning" onclick="showAdvancedSettings()" style="margin-bottom: 20px;">دسترسی پیشرفته</button>

            <div id="advanced-settings-fields" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3>تنظیمات پیشرفته (محرمانه)</h3>
                <div class="settings-grid">
                    <div class="input-item"><label for="setting-username">نام کاربری:</label><input type="text" id="setting-username"></div>
                    <div class="input-item"><label for="setting-password">رمز عبور کاربر:</label><input type="password" id="setting-password" placeholder="برای عدم تغییر، خالی بگذارید"></div>
                    <div class="input-item"><label for="setting-super-password">رمز عبور پیشرفته:</label><input type="password" id="setting-super-password" placeholder="برای عدم تغییر، خالی بگذارید"></div>
                    <div class="input-item"><label for="setting-expire-date">تاریخ انقضا:</label><input type="date" id="setting-expire-date"></div>
                    <div class="input-item">
                        <label for="setting-show-aabsal-logo">نمایش لوگوی آبسال</label>
                        <input type="checkbox" id="setting-show-aabsal-logo">
                    </div>
                </div>
            </div>
            
            <h3>مدیریت انواع ورق</h3>
            <div id="settingTypesList"></div>
            <div class="input-grid" style="margin-top:15px; border-top: 1px solid #ddd; padding-top: 15px;">
                <div class="input-item"><label for="newTypeName">نام نوع جدید:</label><input type="text" id="newTypeName" placeholder="مثال: روغنی"></div>
                <div class="input-item"><label for="newTypeDensity">دانسیته:</label><input type="number" step="0.01" id="newTypeDensity" placeholder="مثال: 7.85"></div>
                <div class="input-item" style="justify-content: flex-end;"><button class="btn btn-primary" onclick="addSettingType()">افزودن نوع</button></div>
            </div>

            <h3>مدیریت ویژگی‌های ورق</h3>
            <div id="settingFeaturesList"></div>
             <div class="input-grid" style="margin-top:15px; border-top: 1px solid #ddd; padding-top: 15px;">
                <div class="input-item"><label for="newFeatureName">نام ویژگی جدید:</label><input type="text" id="newFeatureName" placeholder="مثال: کششی"></div>
                <div class="input-item" style="justify-content: flex-end;"><button class="btn btn-primary" onclick="addSettingFeature()">افزودن ویژگی</button></div>
            </div>

            <div class="form-buttons-container"><button class="btn btn-success" onclick="saveSettings()">ذخیره همه تغییرات</button></div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="showCoilPage()">بازگشت به برنامه</button>
            <span></span>
        </div>`;
}

function populateFormDropdowns() {
    const typeOptions = Object.keys(settings.densities).map(t => `<option value="${t}">${t}</option>`).join('');
    const featureOptions = settings.features.map(f => `<option value="${f}">${f}</option>`).join('');

    document.getElementById('coilType').innerHTML = typeOptions;
    document.getElementById('coilFeature').innerHTML = featureOptions;
    
    document.getElementById('sheetType').innerHTML = typeOptions;
}

// --- DYNAMIC SETTINGS MANAGEMENT ---
function renderSettingTypes() {
    const container = document.getElementById('settingTypesList');
    container.innerHTML = '';
    Object.entries(settings.densities).forEach(([name, density]) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'settings-item';
        itemDiv.innerHTML = `<span>${name} (دانسیته: ${density})</span><button class="btn btn-danger" onclick="deleteSettingType('${name}')">حذف</button>`;
        container.appendChild(itemDiv);
    });
}

function addSettingType() {
    const nameInput = document.getElementById('newTypeName');
    const densityInput = document.getElementById('newTypeDensity');
    const name = nameInput.value.trim();
    const density = parseFloat(densityInput.value);

    if (!name || isNaN(density)) {
        alert('لطفاً نام و دانسیته معتبر وارد کنید.');
        return;
    }
    if (settings.densities[name]) {
        alert('این نوع ورق از قبل وجود دارد.');
        return;
    }
    settings.densities[name] = density;
    nameInput.value = '';
    densityInput.value = '';
    renderSettingTypes();
}

function deleteSettingType(typeName) {
    if (isTypeInUse(typeName)) {
        alert(`امکان حذف "${typeName}" وجود ندارد زیرا در کویل‌ها یا سفارش‌ها استفاده شده است.`);
        return;
    }
    if (confirm(`آیا از حذف نوع ورق "${typeName}" مطمئن هستید؟`)) {
        delete settings.densities[typeName];
        renderSettingTypes();
    }
}

function renderSettingFeatures() {
    const container = document.getElementById('settingFeaturesList');
    container.innerHTML = '';
    settings.features.forEach(name => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'settings-item';
        itemDiv.innerHTML = `<span>${name}</span><button class="btn btn-danger" onclick="deleteSettingFeature('${name}')">حذف</button>`;
        container.appendChild(itemDiv);
    });
}

function addSettingFeature() {
    const nameInput = document.getElementById('newFeatureName');
    const name = nameInput.value.trim();
    if (!name) {
        alert('لطفاً نام ویژگی را وارد کنید.');
        return;
    }
    if (settings.features.includes(name)) {
        alert('این ویژگی از قبل وجود دارد.');
        return;
    }
    settings.features.push(name);
    nameInput.value = '';
    renderSettingFeatures();
}

function deleteSettingFeature(featureName) {
    if (isFeatureInUse(featureName)) {
        alert(`امکان حذف "${featureName}" وجود ندارد زیرا در کویل‌ها یا سفارش‌ها استفاده شده است.`);
        return;
    }
    if (confirm(`آیا از حذف ویژگی "${featureName}" مطمئن هستید؟`)) {
        settings.features = settings.features.filter(f => f !== featureName);
        renderSettingFeatures();
    }
}

// --- DATA INTEGRITY CHECKS ---
function isTypeInUse(typeName) {
    return coils.some(c => c.type === typeName) || sheetOrders.some(s => s.type === typeName);
}

function isFeatureInUse(featureName) {
    return coils.some(c => c.feature === featureName) || sheetOrders.some(s => s.feature === featureName);
}

// --- UI & NAVIGATION ---
function updateLogoVisibility() {
    const logo = document.getElementById('aabsalLogo');
    if (logo) {
        logo.style.display = settings.showAabsalLogo ? 'block' : 'none';
    }
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

function showCoilPage() { showPage('page-coils'); }

function showSheetPage() {
    if (coils.length === 0) {
        showAlert('ابتدا باید حداقل یک کویل اضافه کنید.');
        return;
    }
    showPage('page-sheets');
    updateSheetDependencies();
}

function showResultsPage() { showPage('page-results'); }

function showSettingsPage() {
    showPage('page-settings');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('login-section').style.display = 'block';
    document.getElementById('settings-section').style.display = 'none';
    
    const advancedFields = document.getElementById('advanced-settings-fields');
    if (advancedFields) {
        advancedFields.style.display = 'none';
    }
}

// --- BULK ACTIONS ---
function startOver() {
    if (confirm('آیا مطمئن هستید؟ تمام کویل‌ها و ابعاد ذخیره شده پاک خواهند شد.')) {
        coils = [];
        sheetOrders = [];
        localStorage.removeItem(COILS_STORAGE_KEY);
        localStorage.removeItem(ORDERS_STORAGE_KEY);
        renderCoilList();
        renderSheetOrderList();
        document.getElementById('resultsContainer').innerHTML = '';
        showCoilPage();
    }
}

function clearAllCoils() {
    if (coils.length === 0) {
        alert("لیست کویل‌ها از قبل خالی است.");
        return;
    }
    if (confirm('آیا مطمئن هستید که می‌خواهید لیست تمام کویل‌ها را پاک کنید؟ این عمل غیرقابل بازگشت است.')) {
        coils = [];
        localStorage.removeItem(COILS_STORAGE_KEY);
        renderCoilList();
        alert('لیست کویل‌ها با موفقیت پاک شد.');
    }
}

function clearAllSheetOrders() {
    if (sheetOrders.length === 0) {
        alert("لیست ابعاد برش از قبل خالی است.");
        return;
    }
    if (confirm('آیا مطمئن هستید که می‌خواهید لیست تمام ابعاد برش را پاک کنید؟ این عمل غیرقابل بازگشت است.')) {
        sheetOrders = [];
        localStorage.removeItem(ORDERS_STORAGE_KEY);
        renderSheetOrderList();
        alert('لیست ابعاد برش با موفقیت پاک شد.');
    }
}


function showAlert(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorModal').style.display = 'flex';
}

function closeModal() { document.getElementById('errorModal').style.display = 'none'; }
function showAboutModal() { document.getElementById('aboutModal').style.display = 'flex'; }
function closeAboutModal() { document.getElementById('aboutModal').style.display = 'none'; }
function showHelpModal() { document.getElementById('helpModal').style.display = 'flex'; }
function closeHelpModal() { document.getElementById('helpModal').style.display = 'none'; }

// --- DATA MANAGEMENT & LOCAL STORAGE ---
function saveDataToLocalStorage() {
    localStorage.setItem(COILS_STORAGE_KEY, JSON.stringify(coils));
    localStorage.setItem(ORDERS_STORAGE_KEY, JSON.stringify(sheetOrders));
}

function loadDataFromLocalStorage() {
    const savedCoils = localStorage.getItem(COILS_STORAGE_KEY);
    const savedOrders = localStorage.getItem(ORDERS_STORAGE_KEY);
    if (savedCoils) coils = JSON.parse(savedCoils);
    if (savedOrders) sheetOrders = JSON.parse(savedOrders);
}

function updateDensity() {
    const selectedType = document.getElementById('coilType').value;
    document.getElementById('coilDensity').value = settings.densities[selectedType] || 0;
}

// --- XLSX IMPORT / EXPORT ---
function exportToXLSX(type) {
    let data, filename;
    if (type === 'coils') {
        data = coils.map(c => ({ 'کد انبار': c.companyCode, 'نوع': c.type, 'ویژگی': c.feature, 'وزن': c.originalWeight, 'عرض': c.width, 'ضخامت': c.thickness, 'دانسیته': c.density }));
        filename = "coils-export.xlsx";
    } else {
        data = sheetOrders.map(s => ({ 'کد انبار': s.companyCode, 'نوع': s.type, 'ویژگی': s.feature, 'طول': s.length, 'عرض': s.width, 'ضخامت': s.thickness }));
        filename = "sheets-export.xlsx";
    }
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, filename);
}

function importFromXLSX(type) {
    const replace = confirm("آیا می‌خواهید داده‌های فعلی با محتوای این فایل جایگزین شوند؟\n\n(برای افزودن ردیف‌های جدید به لیست فعلی، Cancel را بزنید)");
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = ".xlsx, .xls";
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            if (type === 'coils') {
                processImportedCoils(json, replace);
            } else {
                processImportedSheets(json, replace);
            }
        };
        reader.readAsArrayBuffer(file);
    };
    input.click();
}

function processImportedCoils(data, replace) {
    if (replace) coils = [];
    let importedCount = 0, skippedCount = 0;
    let skippedReasons = [];
    
    data.forEach((row, index) => {
        const newCoil = {
            companyCode: row['کد انبار']?.toString().trim(),
            type: row['نوع']?.trim(),
            feature: row['ویژگی']?.toString().trim(),
            originalWeight: parseFloat(row['وزن']),
            width: parseFloat(row['عرض']),
            thickness: parseFloat(row['ضخامت']),
            density: parseFloat(row['دانسیته'])
        };
        
        const isValid = newCoil.companyCode && newCoil.type && newCoil.feature && !isNaN(newCoil.originalWeight) && !isNaN(newCoil.width) && !isNaN(newCoil.thickness) && !isNaN(newCoil.density);
        if (!isValid) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2}: داده‌های ناقص یا نامعتبر.`);
            return;
        }

        if (!Object.keys(settings.densities).includes(newCoil.type) || !settings.features.includes(newCoil.feature)) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2}: نوع یا ویژگی ورق در تنظیمات برنامه تعریف نشده است.`);
            return;
        }

        if (coils.some(c => c.companyCode === newCoil.companyCode)) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2} (${newCoil.companyCode}): کد انبار تکراری است.`);
            return;
        }

        newCoil.id = 'C' + Date.now() + Math.random();
        newCoil.weight = newCoil.originalWeight;
        coils.push(newCoil);
        importedCount++;
    });

    renderCoilList();
    saveDataToLocalStorage();
    let report = `پردازش فایل کویل‌ها کامل شد.\n\nتعداد وارد شده: ${importedCount}\nتعداد نادیده گرفته شده: ${skippedCount}`;
    if (skippedCount > 0) report += "\n\nدلایل:\n" + skippedReasons.join("\n");
    alert(report);
}

function processImportedSheets(data, replace) {
    if (replace) sheetOrders = [];
    let importedCount = 0, skippedCount = 0;
    let skippedReasons = [];

    data.forEach((row, index) => {
        const newSheet = {
            companyCode: row['کد انبار']?.toString().trim(),
            type: row['نوع']?.trim(),
            feature: row['ویژگی']?.toString().trim(),
            length: parseFloat(row['طول']),
            width: parseFloat(row['عرض']),
            thickness: parseFloat(row['ضخامت'])
        };

        const isValid = newSheet.companyCode && newSheet.type && newSheet.feature && !isNaN(newSheet.length) && !isNaN(newSheet.width) && !isNaN(newSheet.thickness);
        if (!isValid) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2}: داده‌های ناقص یا نامعتبر.`);
            return;
        }
        
        if (!Object.keys(settings.densities).includes(newSheet.type) || !settings.features.includes(newSheet.feature)) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2}: نوع یا ویژگی ورق در تنظیمات برنامه تعریف نشده است.`);
            return;
        }

        if (sheetOrders.some(s => s.companyCode === newSheet.companyCode)) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2} (${newSheet.companyCode}): کد انبار تکراری است.`);
            return;
        }

        newSheet.id = 'S' + Date.now() + Math.random();
        sheetOrders.push(newSheet);
        importedCount++;
    });

    renderSheetOrderList();
    saveDataToLocalStorage();
    let report = `پردازش فایل ابعاد کامل شد.\n\nتعداد وارد شده: ${importedCount}\nتعداد نادیده گرفته شده: ${skippedCount}`;
    if (skippedCount > 0) report += "\n\nدلایل:\n" + skippedReasons.join("\n");
    alert(report);
}

// --- CRUD & RENDER FUNCTIONS ---
function saveCoil() {
    const type = document.getElementById('coilType').value;
    const companyCode = document.getElementById('coilCompanyCode').value.trim();
    const feature = document.getElementById('coilFeature').value;
    const weight = parseFloat(document.getElementById('coilWeight').value);
    const width = parseFloat(document.getElementById('coilWidth').value);
    const thickness = parseFloat(document.getElementById('coilThickness').value);
    const density = parseFloat(document.getElementById('coilDensity').value);

    if (!companyCode) { showAlert('لطفاً کد انبار را برای کویل وارد کنید.'); return; }
    if (!weight || !width || !thickness || !density || weight <= 0 || width <= 0 || thickness <= 0 || density <= 0) { showAlert('لطفاً تمام مشخصات کویل را با مقادیر مثبت وارد کنید.'); return; }
    if (coils.some(c => c.id !== editingCoilId && c.companyCode === companyCode)) { showAlert('کد انبار وارد شده برای کویل دیگری وجود دارد.'); return; }
    
    if (editingCoilId) {
        const index = coils.findIndex(c => c.id === editingCoilId);
        if (index > -1) {
            coils[index] = { ...coils[index], companyCode, type, feature, weight, originalWeight: weight, width, thickness, density };
        }
        editingCoilId = null;
    } else {
        coils.push({ id: 'C' + Date.now(), companyCode, type, feature, weight, originalWeight: weight, width, thickness, density });
    }

    resetCoilForm();
    renderCoilList();
    saveDataToLocalStorage();
}

function editCoil(id) {
    const coilToEdit = coils.find(c => c.id === id);
    if (!coilToEdit) return;

    editingCoilId = id;
    document.getElementById('coilType').value = coilToEdit.type;
    document.getElementById('coilCompanyCode').value = coilToEdit.companyCode;
    document.getElementById('coilFeature').value = coilToEdit.feature;
    document.getElementById('coilWeight').value = coilToEdit.originalWeight;
    document.getElementById('coilWidth').value = coilToEdit.width;
    document.getElementById('coilThickness').value = coilToEdit.thickness;
    document.getElementById('coilDensity').value = coilToEdit.density;

    document.getElementById('coilSubmitBtn').textContent = 'ذخیره تغییرات';
    document.getElementById('coilSubmitBtn').className = 'btn btn-success';
    document.getElementById('coilCancelBtn').style.display = 'inline-block';
    
    document.querySelector('#page-coils .form-section').scrollIntoView({ behavior: 'smooth' });
}

function deleteCoil(id) {
    if (confirm('آیا از حذف این کویل مطمئن هستید؟')) {
        coils = coils.filter(c => c.id !== id);
        renderCoilList();
        saveDataToLocalStorage();
    }
}

function cancelCoilEdit() {
    editingCoilId = null;
    resetCoilForm();
}

function resetCoilForm() {
    document.getElementById('coilCompanyCode').value = '';
    document.getElementById('coilWeight').value = '';
    document.getElementById('coilWidth').value = '';
    document.getElementById('coilThickness').value = '';
    document.getElementById('coilType').selectedIndex = 0;
    document.getElementById('coilFeature').selectedIndex = 0;
    updateDensity();

    document.getElementById('coilSubmitBtn').textContent = 'افزودن کویل';
    document.getElementById('coilSubmitBtn').className = 'btn btn-primary';
    document.getElementById('coilCancelBtn').style.display = 'none';
}

function renderCoilList() {
    const listDiv = document.getElementById('coilList');
    if (coils.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; padding: 20px;">هنوز کویلی اضافه نشده است.</p>';
        return;
    }

    const tableRows = coils.map(coil => `
        <tr>
            <td>${coil.companyCode}</td>
            <td>${coil.type}</td>
            <td>${coil.feature || '-'}</td>
            <td>${coil.originalWeight}</td>
            <td>${coil.width}</td>
            <td>${coil.thickness}</td>
            <td class="operations-cell">
                <button class="btn btn-warning" onclick="editCoil('${coil.id}')">ویرایش</button>
                <button class="btn btn-danger" onclick="deleteCoil('${coil.id}')">حذف</button>
            </td>
        </tr>
    `).join('');

    listDiv.innerHTML = `<table><thead><tr><th>کد انبار</th><th>نوع</th><th>ویژگی</th><th>وزن (ک.گ)</th><th>عرض (م.م)</th><th>ضخامت (م.م)</th><th>عملیات</th></tr></thead><tbody>${tableRows}</tbody></table>`;
}

// Sheets
function saveSheetOrder() {
    const type = document.getElementById('sheetType').value;
    const companyCode = document.getElementById('sheetCompanyCode').value.trim();
    const thickness = parseFloat(document.getElementById('sheetThickness').value);
    const feature = document.getElementById('sheetFeature').value;
    const length = parseFloat(document.getElementById('sheetLength').value);
    const width = parseFloat(document.getElementById('sheetWidth').value);
    
    if (!companyCode) { showAlert('لطفاً کد انبار را برای ورق وارد کنید.'); return; }
    if (isNaN(thickness)) { showAlert('لطفاً یک ضخامت معتبر انتخاب کنید.'); return; }
    if (!feature) { showAlert('لطفاً یک ویژگی معتبر انتخاب کنید.'); return; }
    if (!length || !width || length <= 0 || width <= 0) { showAlert('لطفاً طول و عرض را با مقادیر مثبت وارد کنید.'); return; }
    if (sheetOrders.some(s => s.id !== editingSheetId && s.companyCode === companyCode)) { showAlert('کد انبار وارد شده برای ورق دیگری وجود دارد.'); return; }
    
    if (editingSheetId) {
        const index = sheetOrders.findIndex(s => s.id === editingSheetId);
        if (index > -1) {
            sheetOrders[index] = { ...sheetOrders[index], companyCode, type, feature, length, width, thickness };
        }
        editingSheetId = null;
    } else {
        sheetOrders.push({ id: 'S' + Date.now(), companyCode, type, feature, length, width, thickness });
    }

    resetSheetForm();
    renderSheetOrderList();
    saveDataToLocalStorage();
}

async function editSheetOrder(id) {
    const orderToEdit = sheetOrders.find(s => s.id === id);
    if (!orderToEdit) return;

    editingSheetId = id;
    document.getElementById('sheetType').value = orderToEdit.type;
    document.getElementById('sheetCompanyCode').value = orderToEdit.companyCode;
    document.getElementById('sheetLength').value = orderToEdit.length;
    document.getElementById('sheetWidth').value = orderToEdit.width;

    await updateSheetDependencies(); 
    document.getElementById('sheetThickness').value = orderToEdit.thickness;
    await updateAvailableFeatures();
    document.getElementById('sheetFeature').value = orderToEdit.feature;

    document.getElementById('sheetSubmitBtn').textContent = 'ذخیره تغییرات';
    document.getElementById('sheetSubmitBtn').className = 'btn btn-success';
    document.getElementById('sheetCancelBtn').style.display = 'inline-block';
    
    document.querySelector('#page-sheets .form-section').scrollIntoView({ behavior: 'smooth' });
}

function deleteSheetOrder(id) {
    if (confirm('آیا از حذف این ابعاد برش مطمئن هستید؟')) {
        sheetOrders = sheetOrders.filter(s => s.id !== id);
        renderSheetOrderList();
        saveDataToLocalStorage();
    }
}

function cancelSheetEdit() {
    editingSheetId = null;
    resetSheetForm();
}

function resetSheetForm() {
    document.getElementById('sheetCompanyCode').value = '';
    document.getElementById('sheetLength').value = '';
    document.getElementById('sheetWidth').value = '';
    
    document.getElementById('sheetSubmitBtn').textContent = 'افزودن ابعاد';
    document.getElementById('sheetSubmitBtn').className = 'btn btn-primary';
    document.getElementById('sheetCancelBtn').style.display = 'none';
}

function updateSheetDependencies() {
    return new Promise(resolve => {
        updateAvailableThicknesses();
        resolve();
    });
}

function updateAvailableThicknesses() {
    const selectedType = document.getElementById('sheetType').value;
    const thicknessSelect = document.getElementById('sheetThickness');
    const currentValue = thicknessSelect.value;
    
    const relevantThicknesses = coils
        .filter(c => c.type === selectedType)
        .map(c => c.thickness);
    
    const uniqueThicknesses = [...new Set(relevantThicknesses)].sort((a, b) => a - b);
    
    if (uniqueThicknesses.length > 0) {
        thicknessSelect.innerHTML = uniqueThicknesses.map(t => `<option value="${t}">${t}</option>`).join('');
        if (uniqueThicknesses.includes(parseFloat(currentValue))) {
            thicknessSelect.value = currentValue;
        }
    } else {
        thicknessSelect.innerHTML = '<option disabled>کویلی با این نوع یافت نشد</option>';
    }
    updateAvailableFeatures();
}

function updateAvailableFeatures() {
    return new Promise(resolve => {
        const selectedType = document.getElementById('sheetType').value;
        const selectedThickness = parseFloat(document.getElementById('sheetThickness').value);
        const featureSelect = document.getElementById('sheetFeature');
        const currentValue = featureSelect.value;

        if (isNaN(selectedThickness)) {
            featureSelect.innerHTML = '<option disabled>ابتدا ضخامت انتخاب کنید</option>';
            resolve();
            return;
        }

        const featuresInInventory = new Set(coils
            .filter(c => c.type === selectedType && c.thickness === selectedThickness)
            .map(c => c.feature)
        );

        let addedAny = false;
        let optionsHTML = '';
        settings.features.forEach(feat => {
            if (featuresInInventory.has(feat)) {
                optionsHTML += `<option value="${feat}">${feat}</option>`;
                addedAny = true;
            }
        });
        
        featureSelect.innerHTML = optionsHTML;

        if (addedAny) {
            if (Array.from(featuresInInventory).includes(currentValue)) {
                 featureSelect.value = currentValue;
            }
        } else {
            featureSelect.innerHTML = '<option disabled>ویژگی منطبقی یافت نشد</option>';
        }
        resolve();
    });
}

function renderSheetOrderList() {
    const listDiv = document.getElementById('sheetOrderList');
    if (sheetOrders.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; padding: 20px;">هنوز ابعاد برشی اضافه نشده است.</p>';
        return;
    }
    
    const tableRows = sheetOrders.map(order => `
        <tr>
            <td>${order.companyCode}</td>
            <td>${order.type}</td>
            <td>${order.feature || '-'}</td>
            <td>${order.thickness}</td>
            <td>${order.length}×${order.width}</td>
            <td class="operations-cell">
                <button class="btn btn-warning" onclick="editSheetOrder('${order.id}')">ویرایش</button>
                <button class="btn btn-danger" onclick="deleteSheetOrder('${order.id}')">حذف</button>
            </td>
        </tr>
    `).join('');

    listDiv.innerHTML = `<table><thead><tr><th>کد انبار</th><th>نوع</th><th>ویژگی</th><th>ضخامت</th><th>ابعاد (م.م)</th><th>عملیات</th></tr></thead><tbody>${tableRows}</tbody></table>`;
}

// --- CORE OPTIMIZATION LOGIC ---
function runOptimization() {
    if (sheetOrders.length === 0) {
        showAlert('ابتدا باید حداقل یک ابعاد برش اضافه کنید.');
        return;
    }
    const maxWastePercentage = parseFloat(document.getElementById('maxWaste').value);
    if (isNaN(maxWastePercentage) || maxWastePercentage < 0 || maxWastePercentage > 100) {
        showAlert('لطفاً برای حداکثر ضایعات، یک عدد بین ۰ تا ۱۰۰ وارد کنید.');
        return;
    }

    const availableCoils = JSON.parse(JSON.stringify(coils));
    const pendingOrders = JSON.parse(JSON.stringify(sheetOrders));
    const resultsContainer = document.getElementById('resultsContainer');
    resultsContainer.innerHTML = 'در حال پردازش...';

    setTimeout(() => {
        resultsContainer.innerHTML = '';
        const groupKey = (item) => `${item.type}-${item.feature}-${item.thickness}`;
        const groupedCoils = availableCoils.reduce((acc, coil) => { const key = groupKey(coil); if (!acc[key]) acc[key] = []; acc[key].push(coil); return acc; }, {});
        const groupedOrders = pendingOrders.reduce((acc, order) => { const key = groupKey(order); if (!acc[key]) acc[key] = []; acc[key].push(order); return acc; }, {});

        let hasAnyResultsAtAll = false;
        
        for (const key in groupedOrders) {
            const ordersInGroup = groupedOrders[key];
            const coilsInGroup = groupedCoils[key] || [];
            const [type, feature, thickness] = key.split('-');

            const groupResultDiv = document.createElement('div');
            groupResultDiv.className = 'result-group';
            groupResultDiv.innerHTML = `<h3>گروه برش: ورق ${type} (ویژگی: ${feature}) با ضخامت ${thickness} میلی‌متر</h3>`;
            resultsContainer.appendChild(groupResultDiv);

            if (coilsInGroup.length === 0) {
                groupResultDiv.innerHTML += '<p style="color: #dc3545;">هیچ کویل منطبقی برای این گروه از ابعاد یافت نشد.</p>';
                continue;
            }

            let allPossiblePlans = [];
            const planSignatures = new Set();
            for (const coil of coilsInGroup) {
                const patternsForThisCoil = findAllWidthPatterns(ordersInGroup, coil.width);
                for (const pattern of patternsForThisCoil) {
                    const coilLengthMm = calculateCoilLength(coil);
                    const cutsPossible = Math.floor(coilLengthMm / pattern.cutLength);
                    if (cutsPossible > 0) {
                        const usefulArea = pattern.sheets.reduce((sum, s) => sum + (s.length * s.width * s.countInPattern), 0);
                        const consumedArea = pattern.cutLength * coil.width;
                        const wastePercentage = consumedArea > 0 ? ((consumedArea - usefulArea) / consumedArea) * 100 : 0;
                        const planSignature = `${coil.id}-${pattern.signature}`;
                        if (!planSignatures.has(planSignature)) {
                            allPossiblePlans.push({ coil, pattern, wastePercentage, cutsPossible });
                            planSignatures.add(planSignature);
                        }
                    }
                }
            }

            const filteredPlans = allPossiblePlans.filter(plan => plan.wastePercentage <= maxWastePercentage).sort((a, b) => a.wastePercentage - b.wastePercentage);

            if (filteredPlans.length === 0) {
                if (allPossiblePlans.length > 0) {
                    groupResultDiv.innerHTML += `<p style="color: #ffc107; font-weight: bold;">طرح‌های قابل اجرا یافت شد، اما ضایعات آنها بیشتر از ${maxWastePercentage}% بود.</p>`;
                } else {
                    groupResultDiv.innerHTML += '<p style="color: #dc3545; font-weight: bold;">هیچ طرح برش قابل اجرایی با ترکیب کویل‌ها و ابعاد این گروه یافت نشد.</p>';
                }
            } else {
                hasAnyResultsAtAll = true;
                filteredPlans.forEach(plan => {
                    groupResultDiv.appendChild(createPlanCard(plan));
                });
            }
        }
        
        if (!hasAnyResultsAtAll && Object.keys(groupedOrders).length === 0) {
            resultsContainer.innerHTML = '<p>هیچ ابعاد برشی برای پردازش وجود ندارد.</p>';
        }

        showResultsPage();
    }, 50);
}

function findAllWidthPatterns(orders, coilWidth) {
    const allPatterns = new Map();

    function findCombinations(startIndex, currentPattern) {
        for (let i = startIndex; i < orders.length; i++) {
            const order = orders[i];
            
            if (currentPattern.totalWidth + order.width <= coilWidth) {
                const newPattern = JSON.parse(JSON.stringify(currentPattern));
                newPattern.sheets.push({ ...order, useDim: order.width, otherDim: order.length, orientation: 'طولی' });
                newPattern.totalWidth += order.width;
                addPattern(newPattern);
                findCombinations(i, newPattern);
            }
            
            if (order.length !== order.width && currentPattern.totalWidth + order.length <= coilWidth) {
                const newPattern = JSON.parse(JSON.stringify(currentPattern));
                newPattern.sheets.push({ ...order, useDim: order.length, otherDim: order.width, orientation: 'عرضی' });
                newPattern.totalWidth += order.length;
                addPattern(newPattern);
                findCombinations(i, newPattern);
            }
        }
    }

    function addPattern(pattern) {
        const consolidatedSheets = {};
        pattern.sheets.forEach(sheet => {
            const key = `${sheet.id}-${sheet.orientation}`;
            if (consolidatedSheets[key]) {
                consolidatedSheets[key].countInPattern++;
            } else {
                consolidatedSheets[key] = { ...sheet, countInPattern: 1 };
            }
        });
        
        const finalSheets = Object.values(consolidatedSheets);
        const signature = finalSheets.map(s => `${s.id}:${s.orientation}:${s.countInPattern}`).sort().join(';');
        
        if (!allPatterns.has(signature)) {
            let totalWidth = 0;
            let cutLength = 0;
            finalSheets.forEach(s => {
                totalWidth += s.useDim * s.countInPattern;
                cutLength = Math.max(cutLength, s.otherDim);
            });
            allPatterns.set(signature, { sheets: finalSheets, totalWidth, cutLength, signature });
        }
    }

    findCombinations(0, { sheets: [], totalWidth: 0 });
    return Array.from(allPatterns.values());
}

function calculateCoilLength(coil) {
    if (coil.weight <= 0) return 0;
    const coilVolCm3 = (coil.weight * 1000) / coil.density;
    const lengthMm = (coilVolCm3 / ((coil.thickness / 10) * (coil.width / 10))) * 10;
    return lengthMm;
}

function createPlanCard(plan) {
    const card = document.createElement('div');
    card.className = 'result-card';
    card.style.cssText = "background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);";
    
    const { coil, pattern, wastePercentage, cutsPossible } = plan;

    const sheetListHtml = pattern.sheets.map(s => 
        `<li><strong>${s.countInPattern} عدد</strong> ورق ${s.length}×${s.width} (کد: ${s.companyCode}, برش ${s.orientation})</li>`
    ).join('');

    card.innerHTML = `
        <h4 style="display: flex; justify-content: space-between; align-items: center;">
            <span>طرح برش از کویل ${coil.companyCode} (عرض: ${coil.width} م.م)</span>
            <span style="color: ${wastePercentage > 10 ? '#dc3545' : '#28a745'}; font-weight: bold;">ضایعات: ${wastePercentage.toFixed(2)}%</span>
        </h4>
        <p><strong>الگوی ترکیبی پیشنهادی:</strong></p>
        <ul style="padding-right: 20px;">${sheetListHtml}</ul>
        <p>این الگو <strong>${pattern.totalWidth} میلی‌متر</strong> از عرض کویل را اشغال می‌کند و هر تکرار آن به نواری به طول <strong>${pattern.cutLength} میلی‌متر</strong> نیاز دارد.</p>
        <hr>
        <div style="font-size: 1.1em; font-weight: bold; text-align: center; color: #333;">
            تعداد تکرار ممکن از این الگو: <span style="color: #667eea; font-size: 1.2em;">${cutsPossible}</span>
        </div>`;
    
    return card;
}

</script>
</body>
</html>
