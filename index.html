<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم کاوش طرح‌های برش</title>
    <!-- افزودن کتابخانه SheetJS برای کار با فایل‌های اکسل -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-FD-NL.woff2') format('woff2');
            font-weight: 100 900;
            font-style: normal;
            font-display: swap;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Vazirmatn', sans-serif; margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container {
            max-width: 1200px; margin: 20px auto; background: white;
            border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px; position: relative; overflow: hidden;
        }
        .logo-image {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 100px;
            height: auto;
            z-index: 1;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .logo-image:hover {
            transform: scale(1.1);
        }
        h1 {
            text-align: center; color: #333; margin-bottom: 25px; font-size: 2em;
            font-weight: 800; background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            position: relative; z-index: 1;
        }
        .page { display: none; }
        .page.active { display: block; }
        .form-section, .list-section, .results-section {
            background: #f8f9fa; padding: 20px; border-radius: 10px;
            margin-bottom: 20px; border: 1px solid #e9ecef;
            position: relative; z-index: 1;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #667eea;
            margin-bottom: 20px;
        }
        .section-header h2 {
            border-bottom: none;
            margin-bottom: 10px;
        }
        .section-header .io-buttons {
            display: flex;
            gap: 10px;
        }
        .io-buttons .btn {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 15px;
        }
        h2 {
            color: #495057; margin-top: 0; margin-bottom: 20px; font-size: 1.6em;
            font-weight: 700;
        }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .input-item { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 700; color: #495057; }
        input, select {
            padding: 10px; border: 2px solid #ced4da; border-radius: 5px;
            font-size: 16px; font-family: 'Vazirmatn', sans-serif; transition: border-color 0.3s;
            background-color: white;
        }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .btn {
            font-family: 'Vazirmatn', sans-serif; color: white; padding: 12px 25px;
            border: none; border-radius: 25px; font-size: 16px; font-weight: 700;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; text-align: center;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(45deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(45deg, #28a745, #20c997); }
        .btn-secondary { background: #6c757d; }
        .btn-warning { background: #ffc107; color: #212529;}
        .btn-danger { background: #dc3545; }
        .form-buttons-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .form-buttons-container .btn { width: 45%; max-width: 220px; margin: 0; }
        .nav-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 15px; }
        .table-container { margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #e9ecef; }
        th { background: #667eea; color: white; font-weight: 700; }
        td { background: white; }
        tr:hover { background-color: #f1f3f5; }
        .operations-cell { display: flex; gap: 8px; align-items: center; }
        .operations-cell .btn { padding: 5px 10px; font-size: 12px; border-radius: 5px; margin: 0; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-content h2 { text-align: center; margin-top: 0; }
        #errorModal .modal-content p { color: #721c24; margin: 0 0 20px; font-size: 1.1em; text-align: center; }
        #aboutModal .modal-content p { color: #333; margin: 10px 0; font-size: 1.1em; text-align: right; }
        #aboutModal .modal-content p strong { color: #667eea; }
        .close-btn { position: absolute; top: 15px; left: 15px; font-size: 1.4em; cursor: pointer; color: #aaa; }
        .app-footer { text-align: left; margin-top: 30px; border-top: 1px solid #e9ecef; padding-top: 15px; }
        .app-footer .btn { font-size: 14px; padding: 8px 15px; }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <img src="images/Saeed4.png" alt="درباره برنامه" title="درباره برنامه" class="logo-image" onclick="showAboutModal()">
        <h1>سیستم کاوش طرح‌های برش</h1>
        
        <!-- MODALS -->
        <div id="errorModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeModal()">×</span><p id="errorMessage"></p><button class="btn btn-primary" onclick="closeModal()">بستن</button></div></div>
        <div id="aboutModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeAboutModal()">×</span><h2>درباره برنامه</h2><p><strong>نویسنده برنامه:</strong> سعید گلستانی</p><p><strong>تاریخ ارائه:</strong> ۲۱ تیر ماه ۱۴۰۴</p><p><strong>تلفن تماس:</strong> 09123175863</p><div style="text-align: center; margin-top: 25px;"><button class="btn btn-primary" onclick="closeAboutModal()">بستن</button></div></div></div>
        
        <!-- PAGES (will be populated by JS) -->
        <div id="page-coils" class="page active"></div>
        <div id="page-sheets" class="page"></div>
        <div id="page-results" class="page"></div>
        <div id="page-settings" class="page"></div>

        <div class="app-footer">
            <button class="btn btn-secondary" onclick="showSettingsPage()">تنظیمات</button>
        </div>
    </div>

<script>
// --- GLOBAL VARIABLES & CONSTANTS ---
let coils = [];
let sheetOrders = [];
let editingCoilId = null;
let editingSheetId = null;
let densityMap = {};
let settings = {
    username: 'admin',
    password: '123',
    densities: {
        'روغنی': 7.85,
        'گالوانیزه': 7.84,
        'استیل': 7.83
    },
    expireDate: '2025-12-31'
};

const COILS_STORAGE_KEY = 'cuttingOptimizerCoils_v17';
const ORDERS_STORAGE_KEY = 'cuttingOptimizerOrders_v17';
const SETTINGS_STORAGE_KEY = 'cuttingOptimizerSettings_v17';

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', initializeApp);

function initializeApp() {
    loadSettings();
    if (checkExpiration()) {
        return; // Stop execution if expired
    }
    loadDataFromLocalStorage();
    buildPageHTML();
    showCoilPage();
    updateDensity();
    renderCoilList();
    renderSheetOrderList();
}

// --- SETTINGS & AUTHENTICATION LOGIC ---
function loadSettings() {
    const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
    if (savedSettings) {
        settings = Object.assign({}, settings, JSON.parse(savedSettings));
    }
    densityMap = settings.densities;
}

function saveSettings() {
    const newUsername = document.getElementById('setting-username').value.trim();
    const newPassword = document.getElementById('setting-password').value.trim();
    if (newUsername) settings.username = newUsername;
    if (newPassword) settings.password = newPassword;

    settings.densities['روغنی'] = parseFloat(document.getElementById('setting-density-rouhani').value);
    settings.densities['گالوانیزه'] = parseFloat(document.getElementById('setting-density-galvanizeh').value);
    settings.densities['استیل'] = parseFloat(document.getElementById('setting-density-steel').value);
    settings.expireDate = document.getElementById('setting-expire-date').value;

    localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
    densityMap = settings.densities;
    alert('تنظیمات با موفقیت ذخیره شد.');
    showCoilPage();
}

function checkExpiration() {
    const today = new Date();
    const expire = new Date(settings.expireDate);
    today.setHours(0, 0, 0, 0);

    if (today > expire) {
        document.getElementById('mainContainer').innerHTML = `
            <h1 style="color: #dc3545;">اعتبار این نسخه از برنامه به پایان رسیده است.</h1>
            <p style="text-align: center; font-size: 1.2em;">لطفاً جهت تمدید با پشتیبانی تماس بگیرید.</p>`;
        return true;
    }
    return false;
}

function handleLogin() {
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;

    if (user === settings.username && pass === settings.password) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('settings-section').style.display = 'block';
        populateSettingsForm();
    } else {
        alert('نام کاربری یا رمز عبور اشتباه است.');
    }
}

function populateSettingsForm() {
    document.getElementById('setting-username').value = settings.username;
    document.getElementById('setting-password').value = settings.password;
    document.getElementById('setting-density-rouhani').value = settings.densities['روغنی'];
    document.getElementById('setting-density-galvanizeh').value = settings.densities['گالوانیزه'];
    document.getElementById('setting-density-steel').value = settings.densities['استیل'];
    document.getElementById('setting-expire-date').value = settings.expireDate;
}

// --- HTML & PAGE BUILDING ---
function buildPageHTML() {
    document.getElementById('page-coils').innerHTML = `
        <div class="form-section">
            <h2>مرحله ۱: افزودن و ویرایش کویل‌ها</h2>
            <div class="input-grid">
                <div class="input-item"><label for="coilType">نوع ورق:</label><select id="coilType" onchange="updateDensity()"><option value="روغنی">روغنی</option><option value="گالوانیزه">گالوانیزه</option><option value="استیل">استیل</option></select></div>
                <div class="input-item"><label for="coilCompanyCode">کد شرکت:</label><input type="text" id="coilCompanyCode" placeholder="مثال: COIL123"></div>
                <div class="input-item"><label for="coilWeight">وزن (ک.گ):</label><input type="number" id="coilWeight" placeholder="مثال: 5000"></div>
                <div class="input-item"><label for="coilWidth">عرض (م.م):</label><input type="number" id="coilWidth" placeholder="مثال: 1250"></div>
                <div class="input-item"><label for="coilThickness">ضخامت (م.م):</label><input type="number" id="coilThickness" step="0.01" placeholder="مثال: 0.5"></div>
                <div class="input-item"><label for="coilDensity">دانسیته (g/cm³):</label><input type="number" id="coilDensity" step="0.01" readonly></div>
            </div>
            <div class="form-buttons-container">
                <button id="coilSubmitBtn" class="btn btn-primary" onclick="saveCoil()">افزودن کویل</button>
                <button id="coilCancelBtn" class="btn btn-secondary" onclick="cancelCoilEdit()" style="display: none;">لغو ویرایش</button>
            </div>
        </div>
        <div class="list-section">
            <div class="section-header">
                <h2>لیست کویل‌ها</h2>
                <div class="io-buttons">
                    <button class="btn btn-primary" onclick="importFromXLSX('coils')">ورود از Excel</button>
                    <button class="btn btn-success" onclick="exportToXLSX('coils')">خروجی به Excel</button>
                </div>
            </div>
            <div class="table-container" id="coilList"></div>
        </div>
        <div class="nav-buttons">
            <span></span>
            <button class="btn btn-success" onclick="showSheetPage()">مرحله بعد: افزودن ابعاد برش ←</button>
        </div>`;

    document.getElementById('page-sheets').innerHTML = `
        <div class="form-section">
            <h2>مرحله ۲: افزودن و ویرایش ابعاد برش</h2>
            <div class="input-grid">
                <div class="input-item"><label for="sheetType">نوع ورق:</label><select id="sheetType" onchange="updateAvailableThicknesses()"><option value="روغنی">روغنی</option><option value="گالوانیزه">گالوانیزه</option><option value="استیل">استیل</option></select></div>
                <div class="input-item"><label for="sheetCompanyCode">کد شرکت:</label><input type="text" id="sheetCompanyCode" placeholder="مثال: SHEET456"></div>
                <div class="input-item"><label for="sheetLength">طول ورق (م.م):</label><input type="number" id="sheetLength" placeholder="مثال: 2000"></div>
                <div class="input-item"><label for="sheetWidth">عرض ورق (م.م):</label><input type="number" id="sheetWidth" placeholder="مثال: 1000"></div>
                <div class="input-item"><label for="sheetThickness">ضخامت (م.م):</label><select id="sheetThickness"></select></div>
            </div>
            <div class="form-buttons-container">
                <button id="sheetSubmitBtn" class="btn btn-primary" onclick="saveSheetOrder()">افزودن ابعاد</button>
                <button id="sheetCancelBtn" class="btn btn-secondary" onclick="cancelSheetEdit()" style="display: none;">لغو ویرایش</button>
            </div>
        </div>
        <div class="list-section">
            <div class="section-header">
                <h2>لیست ابعاد برش</h2>
                <div class="io-buttons">
                    <button class="btn btn-primary" onclick="importFromXLSX('sheets')">ورود از Excel</button>
                    <button class="btn btn-success" onclick="exportToXLSX('sheets')">خروجی به Excel</button>
                </div>
            </div>
            <div class="table-container" id="sheetOrderList"></div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="showCoilPage()">→ بازگشت به ورود کویل‌ها</button>
            <div class="input-item" style="flex-grow: 1; max-width: 250px;">
                <label for="maxWaste">حداکثر ضایعات مجاز (%):</label>
                <input type="number" id="maxWaste" min="0" max="100" value="10" placeholder="0-100">
            </div>
            <button class="btn btn-success" onclick="runOptimization()">نمایش طرح‌های ممکن</button>
        </div>`;

    document.getElementById('page-results').innerHTML = `
        <div class="results-section">
            <h2>نتایج: تمام طرح‌های برش ممکن</h2>
            <div id="resultsContainer"></div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-danger" onclick="startOver()">شروع مجدد</button>
            <button class="btn btn-warning" onclick="showSheetPage()">ویرایش ورودی‌ها</button>
        </div>`;

    document.getElementById('page-settings').innerHTML = `
        <div id="login-section">
            <h2>ورود به بخش تنظیمات</h2>
            <div class="settings-grid">
                <div class="input-item"><label for="username">نام کاربری:</label><input type="text" id="username"></div>
                <div class="input-item"><label for="password">رمز عبور:</label><input type="password" id="password"></div>
            </div>
            <div class="form-buttons-container"><button class="btn btn-primary" onclick="handleLogin()">ورود</button></div>
        </div>
        <div id="settings-section" style="display: none;">
            <h2>تنظیمات برنامه</h2>
            <div class="settings-grid">
                <div class="input-item"><label for="setting-username">نام کاربری:</label><input type="text" id="setting-username"></div>
                <div class="input-item"><label for="setting-password">رمز عبور (برای تغییر وارد کنید):</label><input type="text" id="setting-password"></div>
                <div class="input-item"><label for="setting-density-rouhani">دانسیته ورق روغنی:</label><input type="number" step="0.01" id="setting-density-rouhani"></div>
                <div class="input-item"><label for="setting-density-galvanizeh">دانسیته ورق گالوانیزه:</label><input type="number" step="0.01" id="setting-density-galvanizeh"></div>
                <div class="input-item"><label for="setting-density-steel">دانسیته ورق استیل:</label><input type="number" step="0.01" id="setting-density-steel"></div>
                <div class="input-item"><label for="setting-expire-date">تاریخ انقضا:</label><input type="date" id="setting-expire-date"></div>
            </div>
            <div class="form-buttons-container"><button class="btn btn-success" onclick="saveSettings()">ذخیره تنظیمات</button></div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="showCoilPage()">بازگشت به برنامه</button>
            <span></span>
        </div>`;
}


// --- UI & NAVIGATION ---
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

function showCoilPage() { showPage('page-coils'); }

function showSheetPage() {
    if (coils.length === 0 && document.getElementById('page-coils').classList.contains('active')) {
        showAlert('ابتدا باید حداقل یک کویل اضافه کنید.');
        return;
    }
    showPage('page-sheets');
    updateAvailableThicknesses();
}

function showResultsPage() { showPage('page-results'); }

function showSettingsPage() {
    showPage('page-settings');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('login-section').style.display = 'block';
    document.getElementById('settings-section').style.display = 'none';
}

function startOver() {
    if (confirm('آیا مطمئن هستید؟ تمام کویل‌ها و ابعاد ذخیره شده پاک خواهند شد.')) {
        coils = [];
        sheetOrders = [];
        localStorage.removeItem(COILS_STORAGE_KEY);
        localStorage.removeItem(ORDERS_STORAGE_KEY);
        renderCoilList();
        renderSheetOrderList();
        document.getElementById('resultsContainer').innerHTML = '';
        showCoilPage();
    }
}

function showAlert(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorModal').style.display = 'flex';
}

function closeModal() { document.getElementById('errorModal').style.display = 'none'; }
function showAboutModal() { document.getElementById('aboutModal').style.display = 'flex'; }
function closeAboutModal() { document.getElementById('aboutModal').style.display = 'none'; }


// --- DATA MANAGEMENT & LOCAL STORAGE ---
function saveDataToLocalStorage() {
    localStorage.setItem(COILS_STORAGE_KEY, JSON.stringify(coils));
    localStorage.setItem(ORDERS_STORAGE_KEY, JSON.stringify(sheetOrders));
}

function loadDataFromLocalStorage() {
    const savedCoils = localStorage.getItem(COILS_STORAGE_KEY);
    const savedOrders = localStorage.getItem(ORDERS_STORAGE_KEY);
    if (savedCoils) coils = JSON.parse(savedCoils);
    if (savedOrders) sheetOrders = JSON.parse(savedOrders);
}

function updateDensity() {
    const selectedType = document.getElementById('coilType').value;
    document.getElementById('coilDensity').value = densityMap[selectedType] || 0;
}


// --- XLSX IMPORT / EXPORT ---
function exportToXLSX(type) {
    let data, filename;
    if (type === 'coils') {
        data = coils.map(c => ({ 'کد شرکت': c.companyCode, 'نوع': c.type, 'وزن': c.originalWeight, 'عرض': c.width, 'ضخامت': c.thickness, 'دانسیته': c.density }));
        filename = "coils-export.xlsx";
    } else {
        data = sheetOrders.map(s => ({ 'کد شرکت': s.companyCode, 'نوع': s.type, 'طول': s.length, 'عرض': s.width, 'ضخامت': s.thickness }));
        filename = "sheets-export.xlsx";
    }
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, filename);
}

function importFromXLSX(type) {
    const replace = confirm("آیا می‌خواهید داده‌های فعلی با محتوای این فایل جایگزین شوند؟\n\n(برای افزودن ردیف‌های جدید به لیست فعلی، Cancel را بزنید)");
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = ".xlsx, .xls";
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            if (type === 'coils') {
                processImportedCoils(json, replace);
            } else {
                processImportedSheets(json, replace);
            }
        };
        reader.readAsArrayBuffer(file);
    };
    input.click();
}

function processImportedCoils(data, replace) {
    if (replace) coils = [];
    let importedCount = 0, skippedCount = 0;
    let skippedReasons = [];
    
    data.forEach((row, index) => {
        const newCoil = {
            companyCode: row['کد شرکت']?.toString().trim(),
            type: row['نوع']?.trim(),
            originalWeight: parseFloat(row['وزن']),
            width: parseFloat(row['عرض']),
            thickness: parseFloat(row['ضخامت']),
            density: parseFloat(row['دانسیته'])
        };
        
        const isValid = newCoil.companyCode && newCoil.type && !isNaN(newCoil.originalWeight) && !isNaN(newCoil.width) && !isNaN(newCoil.thickness) && !isNaN(newCoil.density);
        if (!isValid) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2}: داده‌های ناقص یا نامعتبر.`);
            return;
        }

        if (coils.some(c => c.companyCode === newCoil.companyCode)) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2} (${newCoil.companyCode}): کد شرکت تکراری است.`);
            return;
        }

        newCoil.id = 'C' + Date.now() + Math.random();
        newCoil.weight = newCoil.originalWeight;
        coils.push(newCoil);
        importedCount++;
    });

    renderCoilList();
    saveDataToLocalStorage();
    let report = `پردازش فایل کامل شد.\n\nتعداد وارد شده: ${importedCount}\nتعداد نادیده گرفته شده: ${skippedCount}`;
    if (skippedCount > 0) report += "\n\nدلایل:\n" + skippedReasons.join("\n");
    alert(report);
}

function processImportedSheets(data, replace) {
    if (replace) sheetOrders = [];
    let importedCount = 0, skippedCount = 0;
    let skippedReasons = [];

    data.forEach((row, index) => {
        const newSheet = {
            companyCode: row['کد شرکت']?.toString().trim(),
            type: row['نوع']?.trim(),
            length: parseFloat(row['طول']),
            width: parseFloat(row['عرض']),
            thickness: parseFloat(row['ضخامت'])
        };

        const isValid = newSheet.companyCode && newSheet.type && !isNaN(newSheet.length) && !isNaN(newSheet.width) && !isNaN(newSheet.thickness);
        if (!isValid) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2}: داده‌های ناقص یا نامعتبر.`);
            return;
        }
        
        if (sheetOrders.some(s => s.companyCode === newSheet.companyCode)) {
            skippedCount++;
            skippedReasons.push(`ردیف ${index + 2} (${newSheet.companyCode}): کد شرکت تکراری است.`);
            return;
        }

        newSheet.id = 'S' + Date.now() + Math.random();
        sheetOrders.push(newSheet);
        importedCount++;
    });

    renderSheetOrderList();
    saveDataToLocalStorage();
    let report = `پردازش فایل کامل شد.\n\nتعداد وارد شده: ${importedCount}\nتعداد نادیده گرفته شده: ${skippedCount}`;
    if (skippedCount > 0) report += "\n\nدلایل:\n" + skippedReasons.join("\n");
    alert(report);
}


// --- COIL MANAGEMENT (CRUD) ---
function saveCoil() {
    const type = document.getElementById('coilType').value;
    const companyCode = document.getElementById('coilCompanyCode').value.trim();
    const weight = parseFloat(document.getElementById('coilWeight').value);
    const width = parseFloat(document.getElementById('coilWidth').value);
    const thickness = parseFloat(document.getElementById('coilThickness').value);
    const density = parseFloat(document.getElementById('coilDensity').value);

    if (!companyCode) { showAlert('لطفاً کد شرکت را برای کویل وارد کنید.'); return; }
    if (!weight || !width || !thickness || !density || weight <= 0 || width <= 0 || thickness <= 0 || density <= 0) { showAlert('لطفاً تمام مشخصات کویل را با مقادیر مثبت وارد کنید.'); return; }
    if (coils.some(c => c.id !== editingCoilId && c.companyCode === companyCode)) { showAlert('کد شرکت وارد شده برای کویل دیگری وجود دارد.'); return; }
    if (coils.some(c => c.id !== editingCoilId && c.type === type && c.width === width && c.thickness === thickness)) { showAlert('کویلی با این نوع، عرض و ضخامت قبلاً اضافه شده است.'); return; }

    if (editingCoilId) {
        const index = coils.findIndex(c => c.id === editingCoilId);
        if (index > -1) {
            coils[index] = { ...coils[index], companyCode, type, weight, originalWeight: weight, width, thickness, density };
        }
        editingCoilId = null;
    } else {
        coils.push({ id: 'C' + Date.now(), companyCode, type, weight, originalWeight: weight, width, thickness, density });
    }

    resetCoilForm();
    renderCoilList();
    saveDataToLocalStorage();
}

function editCoil(id) {
    const coilToEdit = coils.find(c => c.id === id);
    if (!coilToEdit) return;

    editingCoilId = id;
    document.getElementById('coilType').value = coilToEdit.type;
    document.getElementById('coilCompanyCode').value = coilToEdit.companyCode;
    document.getElementById('coilWeight').value = coilToEdit.originalWeight;
    document.getElementById('coilWidth').value = coilToEdit.width;
    document.getElementById('coilThickness').value = coilToEdit.thickness;
    document.getElementById('coilDensity').value = coilToEdit.density;

    const submitBtn = document.getElementById('coilSubmitBtn');
    const cancelBtn = document.getElementById('coilCancelBtn');
    submitBtn.textContent = 'ذخیره تغییرات';
    submitBtn.className = 'btn btn-success';
    cancelBtn.style.display = 'inline-block';
    
    document.getElementById('page-coils').querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
}

function deleteCoil(id) {
    if (confirm('آیا از حذف این کویل مطمئن هستید؟')) {
        coils = coils.filter(c => c.id !== id);
        renderCoilList();
        saveDataToLocalStorage();
    }
}

function cancelCoilEdit() {
    editingCoilId = null;
    resetCoilForm();
}

function resetCoilForm() {
    document.getElementById('coilCompanyCode').value = '';
    document.getElementById('coilWeight').value = '';
    document.getElementById('coilWidth').value = '';
    document.getElementById('coilThickness').value = '';
    updateDensity();

    const submitBtn = document.getElementById('coilSubmitBtn');
    const cancelBtn = document.getElementById('coilCancelBtn');
    submitBtn.textContent = 'افزودن کویل';
    submitBtn.className = 'btn btn-primary';
    cancelBtn.style.display = 'none';
}

function renderCoilList() {
    const listDiv = document.getElementById('coilList');
    if (coils.length === 0) {
        listDiv.innerHTML = '<p>هنوز کویلی اضافه نشده است.</p>';
        return;
    }

    const tableRows = coils.map(coil => `
        <tr>
            <td>${coil.companyCode}</td>
            <td>${coil.type}</td>
            <td>${coil.originalWeight}</td>
            <td>${coil.width}</td>
            <td>${coil.thickness}</td>
            <td>${coil.density}</td>
            <td class="operations-cell">
                <button class="btn btn-warning" onclick="editCoil('${coil.id}')">ویرایش</button>
                <button class="btn btn-danger" onclick="deleteCoil('${coil.id}')">حذف</button>
            </td>
        </tr>
    `).join('');

    listDiv.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>کد شرکت</th><th>نوع</th><th>وزن (ک.گ)</th><th>عرض (م.م)</th>
                    <th>ضخامت (م.م)</th><th>دانسیته</th><th>عملیات</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
        </table>`;
}

// --- SHEET ORDER MANAGEMENT (CRUD) ---
function saveSheetOrder() {
    const type = document.getElementById('sheetType').value;
    const companyCode = document.getElementById('sheetCompanyCode').value.trim();
    const length = parseFloat(document.getElementById('sheetLength').value);
    const width = parseFloat(document.getElementById('sheetWidth').value);
    const thickness = parseFloat(document.getElementById('sheetThickness').value);

    if (!companyCode) { showAlert('لطفاً کد شرکت را برای ورق وارد کنید.'); return; }
    if (isNaN(thickness)) { showAlert('لطفاً یک ضخامت معتبر انتخاب کنید.'); return; }
    if (!length || !width || length <= 0 || width <= 0) { showAlert('لطفاً طول و عرض را با مقادیر مثبت وارد کنید.'); return; }
    if (sheetOrders.some(s => s.id !== editingSheetId && s.companyCode === companyCode)) { showAlert('کد شرکت وارد شده برای ورق دیگری وجود دارد.'); return; }
    if (sheetOrders.some(s => s.id !== editingSheetId && s.type === type && s.length === length && s.width === width && s.thickness === thickness)) { showAlert('ورقی با این نوع، طول، عرض و ضخامت قبلاً اضافه شده است.'); return; }

    if (editingSheetId) {
        const index = sheetOrders.findIndex(s => s.id === editingSheetId);
        if (index > -1) {
            sheetOrders[index] = { ...sheetOrders[index], companyCode, type, length, width, thickness };
        }
        editingSheetId = null;
    } else {
        sheetOrders.push({ id: 'S' + Date.now(), companyCode, type, length, width, thickness });
    }

    resetSheetForm();
    renderSheetOrderList();
    saveDataToLocalStorage();
}

function editSheetOrder(id) {
    const orderToEdit = sheetOrders.find(s => s.id === id);
    if (!orderToEdit) return;

    editingSheetId = id;
    document.getElementById('sheetType').value = orderToEdit.type;
    updateAvailableThicknesses(); // Must be called after setting type
    document.getElementById('sheetCompanyCode').value = orderToEdit.companyCode;
    document.getElementById('sheetLength').value = orderToEdit.length;
    document.getElementById('sheetWidth').value = orderToEdit.width;
    document.getElementById('sheetThickness').value = orderToEdit.thickness;

    const submitBtn = document.getElementById('sheetSubmitBtn');
    const cancelBtn = document.getElementById('sheetCancelBtn');
    submitBtn.textContent = 'ذخیره تغییرات';
    submitBtn.className = 'btn btn-success';
    cancelBtn.style.display = 'inline-block';
    
    document.getElementById('page-sheets').querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
}

function deleteSheetOrder(id) {
    if (confirm('آیا از حذف این ابعاد برش مطمئن هستید؟')) {
        sheetOrders = sheetOrders.filter(s => s.id !== id);
        renderSheetOrderList();
        saveDataToLocalStorage();
    }
}

function cancelSheetEdit() {
    editingSheetId = null;
    resetSheetForm();
}

function resetSheetForm() {
    document.getElementById('sheetCompanyCode').value = '';
    document.getElementById('sheetLength').value = '';
    document.getElementById('sheetWidth').value = '';
    
    const submitBtn = document.getElementById('sheetSubmitBtn');
    const cancelBtn = document.getElementById('sheetCancelBtn');
    submitBtn.textContent = 'افزودن ابعاد';
    submitBtn.className = 'btn btn-primary';
    cancelBtn.style.display = 'none';
}

function updateAvailableThicknesses() {
    const selectedType = document.getElementById('sheetType').value;
    const thicknessSelect = document.getElementById('sheetThickness');
    thicknessSelect.innerHTML = '';

    const relevantCoilThicknesses = coils
        .filter(c => c.type === selectedType)
        .map(c => c.thickness);
    
    const uniqueThicknesses = [...new Set(relevantCoilThicknesses)].sort((a, b) => a - b);
    
    if (uniqueThicknesses.length > 0) {
        uniqueThicknesses.forEach(thick => {
            const option = document.createElement('option');
            option.value = thick;
            option.textContent = thick;
            thicknessSelect.appendChild(option);
        });
    } else {
        const option = document.createElement('option');
        option.textContent = 'کویلی با این نوع یافت نشد';
        option.disabled = true;
        thicknessSelect.appendChild(option);
    }
}

function renderSheetOrderList() {
    const listDiv = document.getElementById('sheetOrderList');
    if (sheetOrders.length === 0) {
        listDiv.innerHTML = '<p>هنوز ابعاد برشی اضافه نشده است.</p>';
        return;
    }
    
    const tableRows = sheetOrders.map(order => `
        <tr>
            <td>${order.companyCode}</td>
            <td>${order.type}</td>
            <td>${order.length}×${order.width}</td>
            <td>${order.thickness}</td>
            <td class="operations-cell">
                <button class="btn btn-warning" onclick="editSheetOrder('${order.id}')">ویرایش</button>
                <button class="btn btn-danger" onclick="deleteSheetOrder('${order.id}')">حذف</button>
            </td>
        </tr>
    `).join('');

    listDiv.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>کد شرکت</th><th>نوع</th><th>ابعاد (م.م)</th><th>ضخامت (م.م)</th><th>عملیات</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
        </table>`;
}


// --- CORE OPTIMIZATION LOGIC ---
function runOptimization() {
    if (sheetOrders.length === 0) {
        showAlert('ابتدا باید حداقل یک ابعاد برش اضافه کنید.');
        return;
    }
    const maxWastePercentage = parseFloat(document.getElementById('maxWaste').value);
    if (isNaN(maxWastePercentage) || maxWastePercentage < 0 || maxWastePercentage > 100) {
        showAlert('لطفاً برای حداکثر ضایعات، یک عدد بین ۰ تا ۱۰۰ وارد کنید.');
        return;
    }

    const availableCoils = JSON.parse(JSON.stringify(coils));
    const pendingOrders = JSON.parse(JSON.stringify(sheetOrders));
    const resultsContainer = document.getElementById('resultsContainer');
    resultsContainer.innerHTML = 'در حال پردازش...';

    // Use setTimeout to prevent UI from freezing during heavy computation
    setTimeout(() => {
        resultsContainer.innerHTML = '';

        // Group coils and orders by type and thickness
        const groupKey = (item) => `${item.type}-${item.thickness}`;
        const groupedCoils = availableCoils.reduce((acc, coil) => {
            const key = groupKey(coil);
            if (!acc[key]) acc[key] = [];
            acc[key].push(coil);
            return acc;
        }, {});
        const groupedOrders = pendingOrders.reduce((acc, order) => {
            const key = groupKey(order);
            if (!acc[key]) acc[key] = [];
            acc[key].push(order);
            return acc;
        }, {});

        let hasAnyResultsAtAll = false;
        
        // Process each group of orders
        for (const key in groupedOrders) {
            const ordersInGroup = groupedOrders[key];
            const coilsInGroup = groupedCoils[key] || [];
            const [type, thickness] = key.split('-');

            const groupResultDiv = document.createElement('div');
            groupResultDiv.className = 'result-group';
            groupResultDiv.innerHTML = `<h3>گروه برش: ورق ${type} با ضخامت ${thickness} میلی‌متر</h3>`;
            resultsContainer.appendChild(groupResultDiv);

            if (coilsInGroup.length === 0) {
                groupResultDiv.innerHTML += '<p style="color: #dc3545;">هیچ کویل منطبقی برای این گروه از ابعاد یافت نشد.</p>';
                continue;
            }

            let allPossiblePlans = [];
            const planSignatures = new Set();
            
            // Find all possible cutting plans for the current group
            for (const coil of coilsInGroup) {
                const patternsForThisCoil = findAllWidthPatterns(ordersInGroup, coil.width);
                for (const pattern of patternsForThisCoil) {
                    const coilLengthMm = calculateCoilLength(coil);
                    const cutsPossible = Math.floor(coilLengthMm / pattern.cutLength);
                    if (cutsPossible > 0) {
                        const usefulAreaInPattern = pattern.sheets.reduce((sum, s) => sum + (s.length * s.width * s.countInPattern), 0);
                        const consumedAreaOfStrip = pattern.cutLength * coil.width;
                        const wastePercentage = consumedAreaOfStrip > 0 ? ((consumedAreaOfStrip - usefulAreaInPattern) / consumedAreaOfStrip) * 100 : 0;
                        const planSignature = `${coil.id}-${pattern.signature}`;
                        
                        if (!planSignatures.has(planSignature)) {
                            allPossiblePlans.push({ coil, pattern, wastePercentage, cutsPossible });
                            planSignatures.add(planSignature);
                        }
                    }
                }
            }

            // Filter plans by max waste and sort by waste percentage
            const filteredPlans = allPossiblePlans.filter(plan => plan.wastePercentage <= maxWastePercentage);
            filteredPlans.sort((a, b) => a.wastePercentage - b.wastePercentage);

            if (filteredPlans.length === 0) {
                if (allPossiblePlans.length > 0) {
                    groupResultDiv.innerHTML += `<p style="color: #ffc107; font-weight: bold;">طرح‌های قابل اجرا یافت شد، اما ضایعات آنها بیشتر از ${maxWastePercentage}% بود.</p>`;
                } else {
                    groupResultDiv.innerHTML += '<p style="color: #dc3545; font-weight: bold;">هیچ طرح برش قابل اجرایی با ترکیب کویل‌ها و ابعاد این گروه یافت نشد.</p>';
                }
            } else {
                hasAnyResultsAtAll = true;
                filteredPlans.forEach(plan => {
                    groupResultDiv.appendChild(createPlanCard(plan));
                });
            }
        }
        
        if (!hasAnyResultsAtAll && Object.keys(groupedOrders).length === 0) {
            resultsContainer.innerHTML = '<p>هیچ ابعاد برشی برای پردازش وجود ندارد.</p>';
        }

        showResultsPage();
    }, 50);
}

function findAllWidthPatterns(orders, coilWidth) {
    const allPatterns = new Map();

    function findCombinations(startIndex, currentPattern) {
        for (let i = startIndex; i < orders.length; i++) {
            const order = orders[i];
            
            // Try fitting with standard orientation (width)
            if (currentPattern.totalWidth + order.width <= coilWidth) {
                const newPattern = JSON.parse(JSON.stringify(currentPattern));
                newPattern.sheets.push({ ...order, useDim: order.width, otherDim: order.length, orientation: 'طولی' });
                newPattern.totalWidth += order.width;
                addPattern(newPattern);
                findCombinations(i, newPattern);
            }
            
            // Try fitting with rotated orientation (length), if different from width
            if (order.length !== order.width && currentPattern.totalWidth + order.length <= coilWidth) {
                const newPattern = JSON.parse(JSON.stringify(currentPattern));
                newPattern.sheets.push({ ...order, useDim: order.length, otherDim: order.width, orientation: 'عرضی' });
                newPattern.totalWidth += order.length;
                addPattern(newPattern);
                findCombinations(i, newPattern);
            }
        }
    }

    function addPattern(pattern) {
        // Consolidate identical sheets in the pattern to get counts
        const consolidatedSheets = {};
        pattern.sheets.forEach(sheet => {
            const key = `${sheet.id}-${sheet.orientation}`;
            if (consolidatedSheets[key]) {
                consolidatedSheets[key].countInPattern++;
            } else {
                consolidatedSheets[key] = { ...sheet, countInPattern: 1 };
            }
        });
        
        const finalSheets = Object.values(consolidatedSheets);
        // Create a unique signature for the pattern to avoid duplicates
        const signature = finalSheets.map(s => `${s.id}:${s.orientation}:${s.countInPattern}`).sort().join(';');
        
        if (!allPatterns.has(signature)) {
            let totalWidth = 0;
            let cutLength = 0; // The length of the strip needed for one repetition of the pattern
            finalSheets.forEach(s => {
                totalWidth += s.useDim * s.countInPattern;
                cutLength = Math.max(cutLength, s.otherDim);
            });
            allPatterns.set(signature, { sheets: finalSheets, totalWidth, cutLength, signature });
        }
    }

    findCombinations(0, { sheets: [], totalWidth: 0 });
    return Array.from(allPatterns.values());
}

function calculateCoilLength(coil) {
    if (coil.weight <= 0) return 0;
    // Volume (cm³) = Weight (g) / Density (g/cm³)
    const coilVolCm3 = (coil.weight * 1000) / coil.density;
    // Area (cm²) = Volume (cm³) / Thickness (cm)
    // Length (cm) = Area (cm²) / Width (cm)
    // Length (mm) = Length (cm) * 10
    const lengthMm = (coilVolCm3 / ((coil.thickness / 10) * (coil.width / 10))) * 10;
    return lengthMm;
}

function createPlanCard(plan) {
    const card = document.createElement('div');
    card.className = 'result-card'; // Add a class for styling if needed
    card.style.cssText = "background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);";
    
    const { coil, pattern, wastePercentage, cutsPossible } = plan;

    const sheetListHtml = pattern.sheets.map(s => 
        `<li><strong>${s.countInPattern} عدد</strong> ورق ${s.length}×${s.width} (کد: ${s.companyCode}, برش ${s.orientation})</li>`
    ).join('');

    card.innerHTML = `
        <h4 style="display: flex; justify-content: space-between; align-items: center;">
            <span>طرح برش از کویل ${coil.companyCode} (عرض: ${coil.width} م.م)</span>
            <span style="color: ${wastePercentage > 10 ? '#dc3545' : '#28a745'}; font-weight: bold;">ضایعات: ${wastePercentage.toFixed(2)}%</span>
        </h4>
        <p><strong>الگوی ترکیبی پیشنهادی:</strong></p>
        <ul style="padding-right: 20px;">${sheetListHtml}</ul>
        <p>این الگو <strong>${pattern.totalWidth} میلی‌متر</strong> از عرض کویل را اشغال می‌کند و هر تکرار آن به نواری به طول <strong>${pattern.cutLength} میلی‌متر</strong> نیاز دارد.</p>
        <hr>
        <div style="font-size: 1.1em; font-weight: bold; text-align: center; color: #333;">
            تعداد تکرار ممکن از این الگو: <span style="color: #667eea; font-size: 1.2em;">${cutsPossible}</span>
        </div>`;
    
    return card;
}
</script>
</body>
</html>
